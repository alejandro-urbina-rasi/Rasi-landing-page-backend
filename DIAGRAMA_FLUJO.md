# ðŸ“Š Diagrama de Flujo - Sistema de Pagos ePayco

Este documento visualiza el flujo completo del sistema de pagos implementado.

---

## ðŸ”„ Flujo Completo de Pago

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           1. USUARIO EN FRONTEND                         â”‚
â”‚                                                                           â”‚
â”‚  Usuario navega â†’ Selecciona Plan â†’ Click "Comprar Ahora"               â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Modal de Checkout (CheckoutModal.jsx)                â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  Formulario:                                                       â”‚   â”‚
â”‚  â”‚  â”œâ”€ Nombre completo                                               â”‚   â”‚
â”‚  â”‚  â”œâ”€ Email                                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€ TelÃ©fono                                                       â”‚   â”‚
â”‚  â”‚  â””â”€ [Registro adicional si es Rasi Assistant]                     â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  [BotÃ³n: Procesar Pago] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                           â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ POST /api/payment/create
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          2. BACKEND - API REST                           â”‚
â”‚                                                                           â”‚
â”‚  paymentController.createPaymentSession()                                â”‚
â”‚  â”‚                                                                        â”‚
â”‚  â”œâ”€ Valida datos del formulario                                          â”‚
â”‚  â”œâ”€ Busca servicio en catÃ¡logo (services.js)                            â”‚
â”‚  â”œâ”€ Calcula precio segÃºn plan (mensual/anual)                           â”‚
â”‚  â”œâ”€ Convierte USD â†’ COP (currencyConverter.js)                          â”‚
â”‚  â”œâ”€ Calcula IVA (19%)                                                    â”‚
â”‚  â”œâ”€ Genera invoice Ãºnico (INV-timestamp-random)                         â”‚
â”‚  â”‚                                                                        â”‚
â”‚  â””â”€ Prepara payload para ePayco:                                         â”‚
â”‚      â”œâ”€ name, description, invoice                                       â”‚
â”‚      â”œâ”€ amount, tax_base, tax                                            â”‚
â”‚      â”œâ”€ email, phone, type_person                                        â”‚
â”‚      â”œâ”€ extra1: serviceId                                                â”‚
â”‚      â”œâ”€ extra2: billingPeriod                                            â”‚
â”‚      â”œâ”€ extra3: fullName                                                 â”‚
â”‚      â”œâ”€ extra4: registrationData (JSON)                                  â”‚
â”‚      â”œâ”€ extra5: salesDate                                                â”‚
â”‚      â”œâ”€ extra6: email                                                    â”‚
â”‚      â”œâ”€ response: EPAYCO_RESPONSE_URL                                    â”‚
â”‚      â””â”€ confirmation: EPAYCO_CONFIRMATION_URL                            â”‚
â”‚                                                                           â”‚
â”‚  createCheckoutSession(payload) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â”‚ POST https://checkout.epayco.co
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         3. ePayco API (EXTERNO)                          â”‚
â”‚                                                                           â”‚
â”‚  Recibe payload â†’ Valida datos â†’ Crea sesiÃ³n de checkout                â”‚
â”‚                                                                           â”‚
â”‚  Responde:                                                                â”‚
â”‚  {                                                                        â”‚
â”‚    "success": true,                                                      â”‚
â”‚    "data": {                                                             â”‚
â”‚      "sessionId": "abc123xyz..."                                         â”‚
â”‚    }                                                                     â”‚
â”‚  }                                                                       â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Retorna sessionId
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       4. BACKEND â†’ FRONTEND                              â”‚
â”‚                                                                           â”‚
â”‚  Backend retorna:                                                         â”‚
â”‚  {                                                                        â”‚
â”‚    "success": true,                                                      â”‚
â”‚    "sessionId": "abc123xyz...",                                          â”‚
â”‚    "invoice": "INV-1234567890-abcd",                                     â”‚
â”‚    "amount": 150000                                                      â”‚
â”‚  }                                                                       â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Recibe sessionId
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    5. FRONTEND - ePayco Smart Checkout                   â”‚
â”‚                                                                           â”‚
â”‚  window.ePayco.checkout.configure({                                      â”‚
â”‚    key: EPAYCO_PUBLIC_KEY,                                               â”‚
â”‚    test: true                                                            â”‚
â”‚  }).open({                                                               â”‚
â”‚    sessionId: "abc123xyz...",                                            â”‚
â”‚    external: false,                                                      â”‚
â”‚    autoclick: true                                                       â”‚
â”‚  });                                                                     â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           ðŸ¦ Modal de ePayco (iframe seguro)                      â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  Usuario ingresa:                                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ NÃºmero de tarjeta                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ Fecha de expiraciÃ³n                                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ CVV                                                            â”‚  â”‚
â”‚  â”‚  â””â”€ [Confirmar Pago]                                              â”‚  â”‚
â”‚  â”‚                                                                    â”‚  â”‚
â”‚  â”‚  ePayco procesa el pago...                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ Valida tarjeta                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ Contacta banco                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ Espera aprobaciÃ³n                                             â”‚  â”‚
â”‚  â”‚  â””â”€ Genera cÃ³digo de aprobaciÃ³n                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                  â”‚
              â”‚ Pago Procesado                  â”‚ Pago Procesado
              â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   6a. WEBHOOK (Servidor)     â”‚  â”‚  6b. RESPUESTA (Navegador)          â”‚
â”‚   POST /api/payment/         â”‚  â”‚  GET /payment-response?             â”‚
â”‚        webhooks/epayco       â”‚  â”‚      ref_payco=123&                 â”‚
â”‚                              â”‚  â”‚      x_response=Aceptada            â”‚
â”‚  (ConfirmaciÃ³n automÃ¡tica)   â”‚  â”‚                                     â”‚
â”‚  âœ… Este es el importante    â”‚  â”‚  (Solo para mostrar al usuario)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ POST con datos del pago
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    7. BACKEND - Procesa Webhook                          â”‚
â”‚                                                                           â”‚
â”‚  paymentController.handleEpaycoWebhook()                                 â”‚
â”‚  â”‚                                                                        â”‚
â”‚  â”œâ”€ ðŸ”’ VALIDACIONES DE SEGURIDAD                                         â”‚
â”‚  â”‚   â”œâ”€ validateEpaycoIP() â†’ Verifica IP de origen                      â”‚
â”‚  â”‚   â””â”€ validateEpaycoSignature() â†’ Verifica firma SHA256               â”‚
â”‚  â”‚                                                                        â”‚
â”‚  â”œâ”€ ðŸ“¥ EXTRAE DATOS DEL WEBHOOK                                          â”‚
â”‚  â”‚   â”œâ”€ x_response: "Aceptada" / "Rechazada" / "Pendiente"             â”‚
â”‚  â”‚   â”œâ”€ x_transaction_id: ID de transacciÃ³n                             â”‚
â”‚  â”‚   â”œâ”€ x_ref_payco: Referencia de ePayco                               â”‚
â”‚  â”‚   â”œâ”€ x_amount: Monto pagado                                          â”‚
â”‚  â”‚   â”œâ”€ x_approval_code: CÃ³digo de aprobaciÃ³n                           â”‚
â”‚  â”‚   â””â”€ x_extra1...x_extra6: Datos personalizados                       â”‚
â”‚  â”‚                                                                        â”‚
â”‚  â””â”€ âœ… SI x_response === "Aceptada"                                      â”‚
â”‚      â”‚                                                                    â”‚
â”‚      â”œâ”€ Identifica servicio (x_extra1)                                   â”‚
â”‚      â”‚                                                                    â”‚
â”‚      â””â”€ BIFURCACIÃ“N POR TIPO DE SERVICIO:                                â”‚
â”‚                                                                           â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚        â”‚  ðŸ¤– RASI ASSISTANT (con registro de usuario)                 â”‚ â”‚
â”‚        â”‚                                                               â”‚ â”‚
â”‚        â”‚  1. Parsea registrationData (x_extra4)                       â”‚ â”‚
â”‚        â”‚  2. registerUserInSaaS() â†’ Crea usuario en SaaS API         â”‚ â”‚
â”‚        â”‚     â””â”€ POST https://saas-api.com/api/auth/registro-publico  â”‚ â”‚
â”‚        â”‚                                                               â”‚ â”‚
â”‚        â”‚  3. assignAssistantCredentials()                             â”‚ â”‚
â”‚        â”‚     â”œâ”€ Genera ID Ãºnico: SAAS-timestamp                       â”‚ â”‚
â”‚        â”‚     â”œâ”€ Guarda en Google Sheets                               â”‚ â”‚
â”‚        â”‚     â””â”€ Marca como "Asignado"                                 â”‚ â”‚
â”‚        â”‚                                                               â”‚ â”‚
â”‚        â”‚  4. sendAssistantCredentials()                               â”‚ â”‚
â”‚        â”‚     â”œâ”€ Email con credenciales                                â”‚ â”‚
â”‚        â”‚     â”œâ”€ Username del SaaS                                     â”‚ â”‚
â”‚        â”‚     â”œâ”€ Password del SaaS                                     â”‚ â”‚
â”‚        â”‚     â”œâ”€ URL: process.env.SAAS_FRONTEND_URL                   â”‚ â”‚
â”‚        â”‚     â””â”€ Fecha de vencimiento                                  â”‚ â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                           â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚        â”‚  ðŸ“… RASI AUTOCITAS (solo registro, no credenciales)         â”‚ â”‚
â”‚        â”‚                                                               â”‚ â”‚
â”‚        â”‚  1. registerAutocitasPurchase()                              â”‚ â”‚
â”‚        â”‚     â”œâ”€ Busca fila disponible en Sheet "Autocitas"           â”‚ â”‚
â”‚        â”‚     â”œâ”€ Guarda datos del cliente                              â”‚ â”‚
â”‚        â”‚     â””â”€ Marca como "Asignado"                                 â”‚ â”‚
â”‚        â”‚                                                               â”‚ â”‚
â”‚        â”‚  2. sendAutocitasConfirmation()                              â”‚ â”‚
â”‚        â”‚     â”œâ”€ Email de confirmaciÃ³n de compra                       â”‚ â”‚
â”‚        â”‚     â”œâ”€ Instrucciones de contacto                             â”‚ â”‚
â”‚        â”‚     â””â”€ Info para proceso de parametrizaciÃ³n                  â”‚ â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                           â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚        â”‚  ðŸ’¬ RASI CHATBOT (solo registro, no credenciales)           â”‚ â”‚
â”‚        â”‚                                                               â”‚ â”‚
â”‚        â”‚  1. registerChatbotPurchase()                                â”‚ â”‚
â”‚        â”‚     â”œâ”€ Busca fila disponible en Sheet "Chatbot"             â”‚ â”‚
â”‚        â”‚     â”œâ”€ Guarda datos del cliente                              â”‚ â”‚
â”‚        â”‚     â””â”€ Marca como "Asignado"                                 â”‚ â”‚
â”‚        â”‚                                                               â”‚ â”‚
â”‚        â”‚  2. sendChatbotConfirmation()                                â”‚ â”‚
â”‚        â”‚     â”œâ”€ Email de confirmaciÃ³n de compra                       â”‚ â”‚
â”‚        â”‚     â”œâ”€ Instrucciones de contacto                             â”‚ â”‚
â”‚        â”‚     â””â”€ Info para proceso de parametrizaciÃ³n                  â”‚ â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                           â”‚
â”‚  âœ… Responde a ePayco: 200 OK                                            â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ Sistema de Reintentos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 WEBHOOK FALLA (error 500, timeout, etc.)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   webhookQueue.enqueueWebhook()                  â”‚
â”‚                                                                   â”‚
â”‚  Se guarda en cola en memoria:                                   â”‚
â”‚  {                                                               â”‚
â”‚    id: "webhook-123",                                            â”‚
â”‚    data: { ... },                                                â”‚
â”‚    attempts: 0,                                                  â”‚
â”‚    maxAttempts: 3,                                               â”‚
â”‚    nextRetry: Date.now() + 30000,                               â”‚
â”‚    status: "pending"                                             â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Procesador de Reintentos (cada 30s)                â”‚
â”‚                                                                   â”‚
â”‚  setInterval(() => {                                             â”‚
â”‚    for (webhook in queue) {                                      â”‚
â”‚      if (webhook.nextRetry <= now) {                             â”‚
â”‚        â”œâ”€ Intento 1 (inmediato)                                  â”‚
â”‚        â”œâ”€ Intento 2 (+30s)                                       â”‚
â”‚        â”œâ”€ Intento 3 (+60s)                                       â”‚
â”‚        â””â”€ Si falla 3 veces â†’ Marca como "failed"                â”‚
â”‚      }                                                            â”‚
â”‚    }                                                             â”‚
â”‚  }, 30000);                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“§ Flujo de EnvÃ­o de Emails

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Pago Exitoso (Webhook procesado)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  emailService.sendAssistantCredentials()         â”‚
â”‚                                                                   â”‚
â”‚  Prepara email HTML con:                                         â”‚
â”‚  â”œâ”€ Plantilla con estilos inline                                â”‚
â”‚  â”œâ”€ Credenciales de acceso                                       â”‚
â”‚  â”œâ”€ URL de acceso a la plataforma                                â”‚
â”‚  â”œâ”€ Beneficios del servicio                                      â”‚
â”‚  â””â”€ Horario de atenciÃ³n y contacto                               â”‚
â”‚                                                                   â”‚
â”‚  nodemailer.transporter.sendMail({                               â”‚
â”‚    from: EMAIL_FROM,                                             â”‚
â”‚    to: email,                                                    â”‚
â”‚    subject: "...",                                               â”‚
â”‚    html: "..."                                                   â”‚
â”‚  })                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚
              âœ… Ã‰xito            âŒ Error
                    â”‚                  â”‚
                    â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Email Enviado       â”‚  â”‚  errorCompensation       â”‚
    â”‚  âœ… Log: "Email      â”‚  â”‚  .registerFailedEmail()  â”‚
    â”‚      enviado"        â”‚  â”‚                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  Se guarda en cola:      â”‚
                              â”‚  {                       â”‚
                              â”‚    type: "email",        â”‚
                              â”‚    data: { ... },        â”‚
                              â”‚    attempts: 0,          â”‚
                              â”‚    maxAttempts: 5        â”‚
                              â”‚  }                       â”‚
                              â”‚                          â”‚
                              â”‚  Reintentos cada 5 min   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ—„ï¸ Google Sheets - Estructura de Datos

### Hoja: "Credenciales" (Rasi Assistant)

```
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ A  â”‚    B     â”‚    C     â”‚          D            â”‚     E     â”‚       F        â”‚    G     â”‚       H       â”‚      I      â”‚    J     â”‚      K       â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID â”‚ Username â”‚ Password â”‚         URL           â”‚ Tipo Plan â”‚    Servicio    â”‚  Estado  â”‚ Email_Vendido â”‚ Fecha_Venta â”‚ Telefono â”‚ VÃ¡lido Hasta â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1 â”‚ user001  â”‚ pass123  â”‚ https://testing.rasi  â”‚ Mensual   â”‚ Rasi Assistant â”‚Disponibleâ”‚               â”‚             â”‚          â”‚              â”‚
â”‚  2 â”‚ user002  â”‚ pass456  â”‚ .net.co               â”‚ Anual     â”‚ Rasi Assistant â”‚Disponibleâ”‚               â”‚             â”‚          â”‚              â”‚
â”‚  3 â”‚ user003  â”‚ pass789  â”‚                       â”‚ Mensual   â”‚ Rasi Assistant â”‚ Asignado â”‚ juan@mail.com â”‚ 01/12/2024  â”‚ 3001234  â”‚ 01/01/2025   â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                                      â”‚
                                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                        â”‚                          â”‚
                                                              Estado: "Disponible"     Estado: "Asignado"
                                                                        â”‚                          â”‚
                                                                âœ… Puede ser        âŒ Ya fue vendido
                                                                   asignado           (en uso)
```

### Hoja: "Autocitas" / "Chatbot" (Rasi Autocitas / Rasi Chatbot)

```
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ A  â”‚     B     â”‚      C      â”‚    D     â”‚       E       â”‚      F      â”‚    G     â”‚      H       â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID â”‚ Tipo Plan â”‚   Servicio  â”‚  Estado  â”‚ Email_Vendido â”‚ Fecha_Venta â”‚ Telefono â”‚ VÃ¡lido Hasta â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1 â”‚ Mensual   â”‚Rasi Autocitasâ”‚Disponibleâ”‚               â”‚             â”‚          â”‚              â”‚
â”‚  2 â”‚ Anual     â”‚Rasi Autocitasâ”‚Disponibleâ”‚               â”‚             â”‚          â”‚              â”‚
â”‚  3 â”‚ Mensual   â”‚Rasi Autocitasâ”‚ Asignado â”‚maria@mail.com â”‚ 03/12/2024  â”‚ 3009876  â”‚ 03/01/2025   â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ” ValidaciÃ³n de Firmas (Webhook)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Webhook llega al backend                       â”‚
â”‚                                                                   â”‚
â”‚  Datos recibidos:                                                â”‚
â”‚  â”œâ”€ x_ref_payco: "123456"                                        â”‚
â”‚  â”œâ”€ x_transaction_id: "789"                                      â”‚
â”‚  â”œâ”€ x_amount: "150000"                                           â”‚
â”‚  â”œâ”€ x_currency_code: "COP"                                       â”‚
â”‚  â””â”€ x_signature: "abc123def456..."  â† Firma de ePayco           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              validateEpaycoSignature(webhookData)                â”‚
â”‚                                                                   â”‚
â”‚  1. Construye string con Private Key y datos:                   â”‚
â”‚     stringToHash =                                               â”‚
â”‚       "PRIVATE_KEY^123456^789^150000^COP"                        â”‚
â”‚                                                                   â”‚
â”‚  2. Calcula SHA256 del string:                                   â”‚
â”‚     calculatedSignature = SHA256(stringToHash)                   â”‚
â”‚       â†’ "abc123def456..."                                        â”‚
â”‚                                                                   â”‚
â”‚  3. Compara con la firma recibida:                               â”‚
â”‚     if (calculatedSignature === x_signature) {                   â”‚
â”‚       âœ… return true  // Firma vÃ¡lida                            â”‚
â”‚     } else {                                                     â”‚
â”‚       âŒ return false // Firma invÃ¡lida â†’ Rechazar webhook       â”‚
â”‚     }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸŒ ConversiÃ³n de Moneda (USD â†’ COP)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Precio del servicio en USD                        â”‚
â”‚                    (definido en services.js)                     â”‚
â”‚                                                                   â”‚
â”‚  Ejemplo: Rasi Assistant Mensual = $50 USD                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              convertUSDtoCOP(amountUSD)                          â”‚
â”‚                                                                   â”‚
â”‚  1. Intenta obtener tasa de cambio en tiempo real:              â”‚
â”‚     GET https://api.frankfurter.app/latest?from=USD&to=COP      â”‚
â”‚     â”œâ”€ âœ… Ã‰xito â†’ Usa tasa actual (ej: 3950 COP/USD)            â”‚
â”‚     â””â”€ âŒ Error â†’ Usa tasa por defecto del .env                 â”‚
â”‚                    (DEFAULT_USD_COP_RATE=3763.85)                â”‚
â”‚                                                                   â”‚
â”‚  2. Calcula monto en COP:                                        â”‚
â”‚     amountCOP = $50 Ã— 3950 = 197,500 COP                        â”‚
â”‚     amountCOP = Math.round(197,500)  // Redondea                â”‚
â”‚                                                                   â”‚
â”‚  3. Calcula IVA (19%):                                           â”‚
â”‚     taxBase = 197,500 / 1.19 = 166,000 COP (base)               â”‚
â”‚     tax = 197,500 - 166,000 = 31,500 COP (IVA)                  â”‚
â”‚                                                                   â”‚
â”‚  4. Retorna:                                                     â”‚
â”‚     {                                                            â”‚
â”‚       amount: 197500,                                            â”‚
â”‚       taxBase: 166000,                                           â”‚
â”‚       tax: 31500                                                 â”‚
â”‚     }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“Š Estados de Transacciones

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Pago Iniciado     â”‚
                    â”‚  (Frontend)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                        â”‚
            Usuario paga            Usuario cancela
                  â”‚                        â”‚
                  â–¼                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  x_response:     â”‚     â”‚  Sin webhook   â”‚
        â”‚  "Aceptada"      â”‚     â”‚  (abandonado)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                      â”‚
   âœ… Webhook OK        âŒ Webhook falla
       â”‚                      â”‚
       â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Estado:     â”‚    â”‚  Estado: En cola   â”‚
â”‚  Completado  â”‚    â”‚  de reintentos     â”‚
â”‚              â”‚    â”‚                    â”‚
â”‚  â”œâ”€ Google   â”‚    â”‚  â†’ Intento 1 (30s) â”‚
â”‚  â”‚  Sheets   â”‚    â”‚  â†’ Intento 2 (60s) â”‚
â”‚  â”‚  guardado â”‚    â”‚  â†’ Intento 3 (90s) â”‚
â”‚  â”‚           â”‚    â”‚                    â”‚
â”‚  â”œâ”€ Email    â”‚    â”‚  âŒ Si falla 3x:   â”‚
â”‚  â”‚  enviado  â”‚    â”‚     Estado: Failed â”‚
â”‚  â”‚           â”‚    â”‚     (requiere      â”‚
â”‚  â””â”€ Usuario  â”‚    â”‚      intervenciÃ³n  â”‚
â”‚     registradoâ”‚   â”‚      manual)       â”‚
â”‚     en SaaS  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸŽ¯ Resumen de Endpoints

```
FRONTEND
â”œâ”€ GET  /                      â†’ Home (PricingPlans)
â”œâ”€ GET  /nosotros              â†’ AboutUs
â”œâ”€ GET  /contacto              â†’ Contact
â””â”€ GET  /payment-response      â†’ PaymentResponse (resultado)

BACKEND
â”œâ”€ POST /api/payment/create                  â†’ Crear sesiÃ³n de pago
â”œâ”€ POST /api/payment/webhooks/epayco         â†’ Webhook de confirmaciÃ³n
â”œâ”€ GET  /api/services                        â†’ CatÃ¡logo de servicios
â”œâ”€ POST /api/contact                         â†’ Formulario de contacto
â””â”€ GET  /api/status                          â†’ Health check

EPAYCO (Externo)
â”œâ”€ POST https://checkout.epayco.co/checkout/api/v2/session
â”‚       â†’ Crear sesiÃ³n de checkout
â””â”€ Script https://checkout.epayco.co/checkout-v2.js
        â†’ Smart Checkout modal
```

---

**Ãšltima actualizaciÃ³n:** Diciembre 2025
**Autor:** Equipo Rasi Soluciones
